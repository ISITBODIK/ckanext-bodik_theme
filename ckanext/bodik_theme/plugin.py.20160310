import ckan.plugins as plugins
import ckan.plugins.toolkit as toolkit
import ckan.lib.helpers as helpers
import sys
import urllib2
import json
import datetime

def dataset_count( search_org ):
    if search_org != "":
        search_org = 'organization:' + search_org
        count = toolkit.get_action('package_search')( data_dict={'fq':search_org } )
        return count['count']
    else:
        count = toolkit.get_action('package_list')( data_dict={} )
        return len(count)

def get_tag():
    result = toolkit.get_action('package_search')( data_dict={'facet.field':'["tags"]' ,'rows':0 } )
    tags1 = result['facets']['tags']

    url = 'http://ckan.open-governmentdata.org/api/3/action/package_search?facet.field=[%22tags%22]&rows=0'
    response = urllib2.urlopen(url)
    s = response.read()
    result = json.loads(s)
    tags2 = result['result']['facets']['tags']

    tags = dict(tags1,**tags2)

    return tags

def render_datetime(datetime_, date_format=None, with_hours=False):
    datetime_ = helpers._datestamp_to_datetime(datetime_)
    jstTime = datetime_ + datetime.timedelta(hours=9)
    return helpers.render_datetime(jstTime, date_format, with_hours)

class BodikThemePlugin(plugins.SingletonPlugin):
    plugins.implements(plugins.IConfigurer)
    plugins.implements(plugins.ITemplateHelpers)
    # IConfigurer

    def update_config(self, config_):
        toolkit.add_template_directory(config_, 'templates')
        toolkit.add_public_directory(config_, 'public')
        toolkit.add_resource('fanstatic', 'bodik_theme')

    def get_helpers(self):
        return {
            'bodik_theme_dataset_count': dataset_count,
            'bodik_theme_get_tag': get_tag,
            'bodik_theme_render_datetime': render_datetime,
        }
